<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testes de SincronizaÃ§Ã£o - RFCP Tracker</title>
  <link rel="stylesheet" href="src/assets/test-sync-styless.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Suite de Testes - SincronizaÃ§Ã£o RFCP</h1>
    <p class="subtitle">ValidaÃ§Ã£o completa do sistema de sincronizaÃ§Ã£o</p>

    <!-- ConfiguraÃ§Ã£o -->
    <div class="config-section">
      <h3>âš™ï¸ ConfiguraÃ§Ã£o de Teste</h3>
      <input type="password" id="test-token" placeholder="Cole seu token do GitHub para testes">
      <button onclick="saveTestToken()">Salvar Token</button>
      <button onclick="clearTestData()">Limpar Dados de Teste</button>
    </div>

    <!-- Resumo -->
    <div class="summary" id="summary">
      <h2>ğŸ“Š Resumo dos Testes</h2>
      <div class="summary-stats">
        <div class="stat">
          <div class="stat-value" style="color: #d4d4d4;" id="total-tests">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #4ec9b0;" id="passed-tests">0</div>
          <div class="stat-label">Passou</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #f48771;" id="failed-tests">0</div>
          <div class="stat-label">Falhou</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color: #3c3c3c;" id="pending-tests">0</div>
          <div class="stat-label">Pendente</div>
        </div>
      </div>
    </div>

    <!-- Controles -->
    <div class="controls">
      <button onclick="runAllTests()">â–¶ï¸ Executar Todos</button>
      <button onclick="runUnitTests()">ğŸ§© Testes UnitÃ¡rios</button>
      <button onclick="runIntegrationTests()">ğŸ”— Testes de IntegraÃ§Ã£o</button>
      <button onclick="runE2ETests()">ğŸ­ Testes E2E</button>
      <button onclick="clearLogs()">ğŸ—‘ï¸ Limpar Log</button>
    </div>

    <!-- Log -->
    <div class="test-section">
      <h2>ğŸ“ Log de ExecuÃ§Ã£o</h2>
      <div class="log" id="test-log"></div>
    </div>

    <!-- Testes UnitÃ¡rios -->
    <div class="test-section">
      <h2>ğŸ§© Testes UnitÃ¡rios</h2>
      <div id="unit-tests"></div>
    </div>

    <!-- Testes de IntegraÃ§Ã£o -->
    <div class="test-section">
      <h2>ğŸ”— Testes de IntegraÃ§Ã£o</h2>
      <div id="integration-tests"></div>
    </div>

    <!-- Testes E2E -->
    <div class="test-section">
      <h2>ğŸ­ Testes End-to-End</h2>
      <div id="e2e-tests"></div>
    </div>
  </div>

  <script src="src/js/sync-manager.js"></script>
  <script>
    let testToken = localStorage.getItem('test_github_token');
    let testResults = {
      total: 0,
      passed: 0,
      failed: 0,
      pending: 0
    };

    // DefiniÃ§Ã£o dos testes
    const unitTests = [
      {
        name: 'SyncManager: Instanciar classe',
        test: () => {
          const sm = new window.SyncManager();
          return sm !== null && sm !== undefined;
        }
      },
      {
        name: 'SyncManager: Verificar propriedades iniciais',
        test: () => {
          const sm = new window.SyncManager();
          return sm.syncEnabled === false && sm.syncInProgress === false;
        }
      },
      {
        name: 'SyncManager: Merge de dados - dados vazios',
        test: () => {
          const sm = new window.SyncManager();
          const local = { completedIds: [], completionDates: {} };
          const remote = { completedIds: [], completionDates: {} };
          const result = sm.mergeProgress(local, remote);
          return result.completedIds.length === 0;
        }
      },
      {
        name: 'SyncManager: Merge de dados - apenas local',
        test: () => {
          const sm = new window.SyncManager();
          const local = { completedIds: ['A', 'B'], completionDates: { A: '2025-01-01', B: '2025-01-02' } };
          const remote = { completedIds: [], completionDates: {} };
          const result = sm.mergeProgress(local, remote);
          return result.completedIds.length === 2;
        }
      },
      {
        name: 'SyncManager: Merge de dados - uniÃ£o de IDs',
        test: () => {
          const sm = new window.SyncManager();
          const local = { completedIds: ['A', 'B'], completionDates: {} };
          const remote = { completedIds: ['B', 'C'], completionDates: {} };
          const result = sm.mergeProgress(local, remote);
          return result.completedIds.length === 3 && 
                 result.completedIds.includes('A') &&
                 result.completedIds.includes('B') &&
                 result.completedIds.includes('C');
        }
      },
      {
        name: 'SyncManager: Merge de datas - mais recente prevalece',
        test: () => {
          const sm = new window.SyncManager();
          const local = { completedIds: ['A'], completionDates: { A: '2025-01-01' } };
          const remote = { completedIds: ['A'], completionDates: { A: '2025-01-05' } };
          const result = sm.mergeProgress(local, remote);
          return result.completionDates.A === '2025-01-05';
        }
      }
    ];

    const integrationTests = [
      {
        name: 'API: Testar conexÃ£o com GitHub',
        test: async () => {
          if (!testToken) throw new Error('Token nÃ£o configurado');
          const response = await fetch('https://api.github.com/user', {
            headers: { 'Authorization': `token ${testToken}` }
          });
          return response.ok;
        }
      },
      {
        name: 'API: Criar Gist de teste',
        test: async () => {
          if (!testToken) throw new Error('Token nÃ£o configurado');
          const sm = new window.SyncManager();
          sm.token = testToken;
          const gist = await sm.createGist();
          localStorage.setItem('test_gist_id', gist.id);
          return gist.id !== null;
        }
      },
      {
        name: 'API: Salvar dados no Gist',
        test: async () => {
          if (!testToken) throw new Error('Token nÃ£o configurado');
          const gistId = localStorage.getItem('test_gist_id');
          if (!gistId) throw new Error('Gist nÃ£o criado');
          
          const sm = new window.SyncManager();
          sm.token = testToken;
          sm.gistId = gistId;
          
          const testData = {
            completedIds: ['TEST-1', 'TEST-2'],
            completionDates: { 'TEST-1': new Date().toISOString() }
          };
          
          await sm.saveRemoteProgress(testData);
          return true;
        }
      },
      {
        name: 'API: Buscar dados do Gist',
        test: async () => {
          if (!testToken) throw new Error('Token nÃ£o configurado');
          const gistId = localStorage.getItem('test_gist_id');
          if (!gistId) throw new Error('Gist nÃ£o criado');
          
          const sm = new window.SyncManager();
          sm.token = testToken;
          sm.gistId = gistId;
          
          const data = await sm.fetchRemoteProgress();
          return data.completedIds && data.completedIds.includes('TEST-1');
        }
      }
    ];

    const e2eTests = [
      {
        name: 'E2E: Fluxo completo - Setup â†’ Save â†’ Load',
        test: async () => {
          if (!testToken) throw new Error('Token nÃ£o configurado');
          
          // 1. Setup
          const sm = new window.SyncManager();
          await sm.setupSync(testToken);
          
          // 2. Save
          const testData = {
            completedIds: ['E2E-1', 'E2E-2', 'E2E-3'],
            completionDates: {
              'E2E-1': '2025-01-01T10:00:00Z',
              'E2E-2': '2025-01-02T11:00:00Z',
              'E2E-3': '2025-01-03T12:00:00Z'
            }
          };
          await sm.saveRemoteProgress(testData);
          
          // 3. Load
          const loaded = await sm.fetchRemoteProgress();
          
          return loaded.completedIds.length === 3 &&
                 loaded.completedIds.includes('E2E-1');
        }
      },
      {
        name: 'E2E: SincronizaÃ§Ã£o bidirecional',
        test: async () => {
          if (!testToken) throw new Error('Token nÃ£o configurado');
          
          const sm = new window.SyncManager();
          await sm.setupSync(testToken);
          
          // Device 1: Dados locais
          const local = {
            completedIds: ['SYNC-A', 'SYNC-B'],
            completionDates: { 'SYNC-A': '2025-01-01', 'SYNC-B': '2025-01-02' }
          };
          
          // Device 2: Dados remotos
          const remote = {
            completedIds: ['SYNC-B', 'SYNC-C'],
            completionDates: { 'SYNC-B': '2025-01-03', 'SYNC-C': '2025-01-04' }
          };
          
          await sm.saveRemoteProgress(remote);
          const synced = await sm.sync(local);
          
          return synced.completedIds.length === 3 &&
                 synced.completedIds.includes('SYNC-A') &&
                 synced.completedIds.includes('SYNC-C');
        }
      },
      {
        name: 'E2E: Limpar dados de teste',
        test: async () => {
          const gistId = localStorage.getItem('test_gist_id');
          if (!gistId || !testToken) return true;
          
          // Deletar Gist de teste
          const response = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `token ${testToken}` }
          });
          
          localStorage.removeItem('test_gist_id');
          return response.status === 204;
        }
      }
    ];

    // FunÃ§Ãµes auxiliares
    function log(message, type = 'info') {
      const logDiv = document.getElementById('test-log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function saveTestToken() {
      const token = document.getElementById('test-token').value;
      if (token) {
        testToken = token;
        localStorage.setItem('test_github_token', token);
        log('âœ“ Token salvo com sucesso', 'info');
      } else {
        log('âœ— Token nÃ£o pode ser vazio', 'error');
      }
    }

    function clearTestData() {
      localStorage.removeItem('test_github_token');
      localStorage.removeItem('test_gist_id');
      testToken = null;
      log('ğŸ—‘ï¸ Dados de teste limpos', 'warn');
    }

    function clearLogs() {
      document.getElementById('test-log').innerHTML = '';
    }

    function updateSummary() {
      document.getElementById('total-tests').textContent = testResults.total;
      document.getElementById('passed-tests').textContent = testResults.passed;
      document.getElementById('failed-tests').textContent = testResults.failed;
      document.getElementById('pending-tests').textContent = testResults.pending;
    }

    async function runTest(test, container) {
      const testCase = document.createElement('div');
      testCase.className = 'test-case';
      testCase.innerHTML = `
        <div class="test-name">${test.name}</div>
        <span class="test-status status-running">EXECUTANDO...</span>
      `;
      container.appendChild(testCase);
      
      testResults.total++;
      testResults.pending--;
      updateSummary();
      
      try {
        log(`â–¶ï¸  Executando: ${test.name}`, 'info');
        const result = await test.test();
        
        if (result) {
          testCase.querySelector('.test-status').className = 'test-status status-pass';
          testCase.querySelector('.test-status').textContent = 'âœ“ PASSOU';
          testResults.passed++;
          log(`âœ“ Passou: ${test.name}`, 'info');
        } else {
          throw new Error('Teste retornou false');
        }
      } catch (error) {
        testCase.querySelector('.test-status').className = 'test-status status-fail';
        testCase.querySelector('.test-status').textContent = 'âœ— FALHOU';
        testCase.innerHTML += `<div class="test-error">Erro: ${error.message}</div>`;
        testResults.failed++;
        log(`âœ— Falhou: ${test.name} - ${error.message}`, 'error');
      }
      
      updateSummary();
    }

    async function runTestSuite(tests, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      for (const test of tests) {
        await runTest(test, container);
      }
    }

    function initTests() {
      testResults = {
        total: 0,
        passed: 0,
        failed: 0,
        pending: unitTests.length + integrationTests.length + e2eTests.length
      };
      
      // Criar placeholders
      [unitTests, integrationTests, e2eTests].forEach((suite, idx) => {
        const containerId = ['unit-tests', 'integration-tests', 'e2e-tests'][idx];
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        suite.forEach(test => {
          const testCase = document.createElement('div');
          testCase.className = 'test-case';
          testCase.innerHTML = `
            <div class="test-name">${test.name}</div>
            <span class="test-status status-pending">PENDENTE</span>
          `;
          container.appendChild(testCase);
        });
      });
      
      updateSummary();
    }

    async function runAllTests() {
      log('ğŸš€ Iniciando todos os testes...', 'info');
      initTests();
      await runUnitTests();
      await runIntegrationTests();
      await runE2ETests();
      log('âœ… Todos os testes concluÃ­dos!', 'info');
    }

    async function runUnitTests() {
      log('ğŸ§© Iniciando testes unitÃ¡rios...', 'info');
      await runTestSuite(unitTests, 'unit-tests');
      log('âœ“ Testes unitÃ¡rios concluÃ­dos', 'info');
    }

    async function runIntegrationTests() {
      log('ğŸ”— Iniciando testes de integraÃ§Ã£o...', 'info');
      await runTestSuite(integrationTests, 'integration-tests');
      log('âœ“ Testes de integraÃ§Ã£o concluÃ­dos', 'info');
    }

    async function runE2ETests() {
      log('ğŸ­ Iniciando testes E2E...', 'info');
      await runTestSuite(e2eTests, 'e2e-tests');
      log('âœ“ Testes E2E concluÃ­dos', 'info');
    }

    // Inicializar
    initTests();
    
    if (testToken) {
      document.getElementById('test-token').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      log('âœ“ Token de teste carregado do localStorage', 'info');
    } else {
      log('âš ï¸ Nenhum token configurado. Configure um token para executar testes de integraÃ§Ã£o.', 'warn');
    }
  </script>
</body>
</html>